<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AUTOLOAD CMD</title>
    <link rel="stylesheet" href="/static/style.css" />

</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1><span>Release</span> Manager</h1>
          <div class="sub">Deployment Control Panel</div>
        </div>
      </div>

      <nav class="nav">
        <a href="#overview" id="navOverview" class="active"><span>▦</span> Overview</a>
        <a href="#config" id="navConfig"><span>⚙</span> Configuration</a>
        <a href="#python" id="navPython"><span>⌁</span> Python Client</a>
      </nav>

      <div class="statusBox">
        <div class="statusRow">
          <div class="statusTitle">STATUS</div>
          <div class="statusState" id="statusText">CHECKING</div>
        </div>
        <div class="bar"><div id="statusBar"></div></div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="crumb"><span class="lineDim">workspace</span> / <b id="pageTitle">Overview</b></div>
        <div class="badge" id="apiBadge"><span class="dot2"></span> API CONNECTED</div>
      </div>

      <section id="pageOverview">
        <div class="grid3">
          <div class="card">
            <div class="title">Active Build</div>
            <div class="big" id="liveVersion">—</div>
            <div class="hint"><span>◉</span><span id="deployState">Deployment Active</span></div>
          </div>

          <div class="card">
            <div class="title">Server Storage</div>
            <div class="bigSmall" id="stealthState">ACTIVE</div>
            <div class="hint hintWarn"><span>◉</span><span id="hiddenFileText">Hidden File: version_info.dat</span></div>
          </div>

          <div class="card">
            <div class="title">Bot Activity</div>
            <div class="bigSmall">READY</div>
            <div class="hint"><span>↗</span><span class="mono" id="endpointText">Endpoint Configured</span></div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHead">
            <div>›_ System Logs</div>
            <div class="pill mono" id="manifestUrlTop">—</div>
          </div>
          <div class="terminal" id="logBox"><span class="lineDim">Waiting for activity...</span></div>
        </div>
      </section>

      <section id="pageConfig" class="hidden">
        <div class="row">
          <div class="panel">
            <div class="panelHead"><div>⚙ Upload / Edit</div></div>

            <div style="display:grid; gap:12px;">
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div>
                  <label>App ID</label>
                  <input id="cfgAppId" placeholder="เช่น 1999x" />
                </div>
                <div>
                  <label>Version</label>
                  <input id="cfgVersion" placeholder="เช่น 1.0.1" />
                </div>
              </div>

              <div>
                <label>Notes (optional)</label>
                <textarea id="cfgNotes" placeholder="release notes / memo..."></textarea>
              </div>

              <div>
                <label>File</label>
                <input id="cfgFile" type="file" />
              </div>

              <div class="btnRow">
                <button onclick="doUpload()">Upload (new record)</button>
                <button onclick="refreshAll()">Refresh</button>
                <button onclick="copyManifest()">Copy Manifest URL</button>
              </div>

              <div style="color:var(--muted); font-size:12px;" id="cfgMsg">—</div>
              <div>
                <span class="pill">Manifest:</span>
                <span class="pill mono" id="manifestUrl">—</span>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>▦ Versions</div>
              <div class="pill mono" id="livePill">LIVE: —</div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>version</th>
                  <th>file</th>
                  <th>sha256</th>
                  <th>rev</th>
                  <th>notes</th>
                  <th>actions</th>
                </tr>
              </thead>
              <tbody id="verBody">
                <tr><td colspan="6" style="color:var(--muted);">—</td></tr>
              </tbody>
            </table>
            <input id="replaceInput" type="file" class="hidden" />
          </div>
        </div>
      </section>

      <section id="pagePython" class="hidden">
        <div class="panel">
          <div class="panelHead"><div>⌁ Python Client (Auto Update)</div></div>
          <div style="color:var(--muted); font-size:12px; margin-bottom:10px;">
            ค่าเวอร์ชั่นจะถูกเก็บในไฟล์ <span class="mono" id="pyHidden">version_info.dat</span>
            (ถ้าเวอร์ชั่นเดิมจะไม่โหลดซ้ำ)
          </div>
          <div class="btnRow">
            <button onclick="copyPython()">Copy Python</button>
          </div>
          <div class="codeBox" id="pyCode"></div>
          <div style="margin-top:10px; color:var(--warn); font-size:12px;">
            * ถ้าคุณ “Replace ไฟล์เดิมโดยไม่เปลี่ยน version” → client ที่เช็คเฉพาะ version จะไม่โหลดซ้ำตามเงื่อนไขเดิม
            (ถ้าอยากบังคับให้โหลด ให้เพิ่ม version หรือปรับ client ให้เช็ค sha/revision เพิ่ม)
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
  const api = (p) => `${location.origin}${p}`;
  const $ = (id) => document.getElementById(id);

  function setPage(hash){
    const page = (hash || "#overview").replace("#","");
    $("pageTitle").textContent = page.charAt(0).toUpperCase()+page.slice(1);

    ["Overview","Config","Python"].forEach(k => $("nav"+k).classList.remove("active"));
    $("pageOverview").classList.add("hidden");
    $("pageConfig").classList.add("hidden");
    $("pagePython").classList.add("hidden");

    if(page === "config"){
      $("navConfig").classList.add("active");
      $("pageConfig").classList.remove("hidden");
    }else if(page === "python"){
      $("navPython").classList.add("active");
      $("pagePython").classList.remove("hidden");
    }else{
      $("navOverview").classList.add("active");
      $("pageOverview").classList.remove("hidden");
    }
  }

  function getAppId(){
    const v = $("cfgAppId").value.trim() || localStorage.getItem("app_id") || "1999x";
    $("cfgAppId").value = v;
    localStorage.setItem("app_id", v);
    return v;
  }

  async function checkHealth(){
    try{
      const r = await fetch(api("/api/health"), {cache:"no-store"});
      if(!r.ok) throw new Error("bad");
      $("apiBadge").style.borderColor = "rgba(31,227,139,.25)";
      $("apiBadge").style.color = "var(--green)";
      $("apiBadge").innerHTML = `<span class="dot2"></span> API CONNECTED`;
      $("statusText").textContent = "ONLINE";
      $("statusText").style.color = "var(--green)";
      $("statusBar").style.width = "78%";
    }catch(e){
      $("apiBadge").style.borderColor = "rgba(255,160,160,.25)";
      $("apiBadge").style.color = "rgba(255,160,160,.95)";
      $("apiBadge").innerHTML = `<span class="dot2" style="background:#ff8f8f"></span> API DISCONNECTED`;
      $("statusText").textContent = "OFFLINE";
      $("statusText").style.color = "rgba(255,160,160,.95)";
      $("statusBar").style.width = "22%";
    }
  }

  async function loadConfig(){
    const r = await fetch(api("/api/config"), {cache:"no-store"});
    const c = await r.json();
    $("stealthState").textContent = c.stealth_mode ? "ACTIVE" : "OFF";
    $("hiddenFileText").textContent = `Hidden File: ${c.hidden_version_file}`;
    $("pyHidden").textContent = c.hidden_version_file;

    const appId = getAppId();
    const code =
`import os, hashlib, requests
from packaging.version import Version

SERVER = "${location.origin}"
APP_ID = "${appId}"
MANIFEST_URL = f"{SERVER}/api/{appId}/latest"
VERSION_FILE = r"${c.hidden_version_file}"
OUT_FILE = "update.bin"  # เปลี่ยนเป็น .exe/.zip ได้

def read_ver():
    if os.path.exists(VERSION_FILE):
        return open(VERSION_FILE, "r", encoding="utf-8").read().strip() or "0.0.0"
    return "0.0.0"

def write_ver(v):
    with open(VERSION_FILE, "w", encoding="utf-8") as f:
        f.write(v)

def sha256_path(p):
    h = hashlib.sha256()
    with open(p, "rb") as f:
        for chunk in iter(lambda: f.read(1024*1024), b""):
            h.update(chunk)
    return h.hexdigest()

def download(url, out_path):
    with requests.get(url, stream=True, timeout=180) as r:
        r.raise_for_status()
        with open(out_path, "wb") as f:
            for chunk in r.iter_content(1024*1024):
                if chunk:
                    f.write(chunk)

def main():
    cur = read_ver()
    m = requests.get(MANIFEST_URL, timeout=30).json()
    latest = m["version"]

    # ไม่โหลดซ้ำถ้าเวอร์ชั่นเดิม
    if Version(latest) <= Version(cur):
        print(f"Up-to-date (skip). current={cur}, latest={latest}")
        return

    url = SERVER + m["download_url"]
    print("New version:", cur, "->", latest)
    download(url, OUT_FILE)

    # ตรวจ sha256 เพื่อความปลอดภัย/กันไฟล์เสีย
    if sha256_path(OUT_FILE).lower() != m["sha256"].lower():
        raise SystemExit("SHA256 mismatch!")

    write_ver(latest)
    print("Downloaded OK. Saved version:", latest)

if __name__ == "__main__":
    main()
`;
    $("pyCode").textContent = code;
  }

  async function refreshLatest(){
    const appId = getAppId();
    const manifest = api(`/api/${encodeURIComponent(appId)}/latest`);
    $("manifestUrl").textContent = manifest;
    $("manifestUrlTop").textContent = manifest;

    try{
      const r = await fetch(manifest, {cache:"no-store"});
      if(!r.ok) throw new Error();
      const m = await r.json();
      $("liveVersion").textContent = m.version;
      $("deployState").textContent = "Deployment Active";
      $("endpointText").textContent = `Endpoint Configured`;
    }catch{
      $("liveVersion").textContent = "—";
      $("deployState").textContent = "No Deployment";
    }

    // live info
    const r2 = await fetch(api(`/api/${encodeURIComponent(appId)}/live`), {cache:"no-store"});
    if(r2.ok){
      const live = await r2.json();
      $("livePill").textContent = live.live_file_id ? `LIVE: #${live.live_file_id}` : "LIVE: (auto latest)";
    }
  }

  async function refreshVersions(){
    const appId = getAppId();
    const body = $("verBody");
    body.innerHTML = `<tr><td colspan="6" style="color:var(--muted);">Loading...</td></tr>`;
    const r = await fetch(api(`/api/${encodeURIComponent(appId)}/versions`), {cache:"no-store"});
    if(!r.ok){
      body.innerHTML = `<tr><td colspan="6" style="color:var(--danger);">Load failed</td></tr>`;
      return;
    }
    const list = await r.json();
    if(!list.length){
      body.innerHTML = `<tr><td colspan="6" style="color:var(--muted);">—</td></tr>`;
      return;
    }

    // get live id
    let liveId = null;
    const lr = await fetch(api(`/api/${encodeURIComponent(appId)}/live`), {cache:"no-store"});
    if(lr.ok){
      const l = await lr.json();
      liveId = l.live_file_id;
    }

    body.innerHTML = "";
    for(const it of list){
      const isLive = (liveId && it.id === liveId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${it.version}${isLive ? ' <span class="pill pillLive">LIVE</span>' : ''}</td>
        <td class="mono">${it.original_name}</td>
        <td class="mono">${it.sha256.slice(0,16)}…</td>
        <td class="mono">${it.revision ?? 1}</td>
        <td>${(it.notes || '').toString().slice(0,80)}</td>
        <td>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="window.open('${it.download_url}','_blank')">download</button>
            <button onclick="setLive(${it.id})">set live</button>
            <button onclick="editMeta(${it.id}, '${it.version.replaceAll("'", "\\'")}', '${(it.notes||"").toString().replaceAll("'", "\\'")}')">edit</button>
            <button class="dangerBtn" onclick="replaceFile(${it.id})">replace file</button>
          </div>
        </td>
      `;
      body.appendChild(tr);
    }
  }

  async function refreshLogs(){
    const box = $("logBox");
    const r = await fetch(api("/api/logs?limit=140"), {cache:"no-store"});
    const data = await r.json();
    if(!data.length){
      box.innerHTML = `<span class="lineDim">Waiting for activity...</span>`;
      return;
    }
    box.textContent = data.map(x => `[${x.ts}] ${x.msg}`).join("\n");
    box.scrollTop = box.scrollHeight;
  }

  async function doUpload(){
    const appId = getAppId();
    const version = $("cfgVersion").value.trim();
    const notes = $("cfgNotes").value.trim();
    const f = $("cfgFile").files[0];
    if(!version){ $("cfgMsg").textContent = "กรอก version"; return; }
    if(!f){ $("cfgMsg").textContent = "เลือกไฟล์"; return; }

    const fd = new FormData();
    fd.append("app_id", appId);
    fd.append("version", version);
    fd.append("notes", notes);
    fd.append("file", f);

    $("cfgMsg").textContent = "Uploading...";
    const res = await fetch(api("/api/upload"), {method:"POST", body:fd});
    const data = await res.json();
    if(!res.ok){ $("cfgMsg").textContent = data.detail || "Upload failed"; return; }
    $("cfgMsg").textContent = `Uploaded: ${data.original_name} (${data.version}) #${data.id}`;
    await refreshAll();
  }

  async function setLive(fileId){
    const appId = getAppId();
    const res = await fetch(api(`/api/${encodeURIComponent(appId)}/set-live`), {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ file_id: fileId })
    });
    const data = await res.json();
    if(!res.ok){ $("cfgMsg").textContent = data.detail || "set live failed"; return; }
    $("cfgMsg").textContent = `Set LIVE: #${fileId}`;
    await refreshAll();
  }

  async function editMeta(fileId, curVersion, curNotes){
    const v = prompt("แก้ version (ปล่อยว่าง = ไม่เปลี่ยน)", curVersion);
    if(v === null) return;
    const n = prompt("แก้ notes (ปล่อยว่างได้)", curNotes || "");
    if(n === null) return;

    const payload = {};
    if(v.trim()) payload.version = v.trim();
    payload.notes = n;

    const res = await fetch(api(`/api/file/${fileId}`), {
      method:"PATCH",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok){ $("cfgMsg").textContent = data.detail || "edit failed"; return; }
    $("cfgMsg").textContent = `Edited #${fileId}`;
    await refreshAll();
  }

  function replaceFile(fileId){
    const inp = $("replaceInput");
    inp.value = "";
    inp.onchange = async () => {
      const f = inp.files[0];
      if(!f) return;
      const fd = new FormData();
      fd.append("file", f);

      $("cfgMsg").textContent = `Replacing file for #${fileId} ...`;
      const res = await fetch(api(`/api/file/${fileId}/replace`), {method:"PUT", body:fd});
      const data = await res.json();
      if(!res.ok){ $("cfgMsg").textContent = data.detail || "replace failed"; return; }
      $("cfgMsg").textContent = `Replaced #${fileId} → rev ${data.revision}`;
      await refreshAll();
    };
    inp.click();
  }

  function copyManifest(){
    const txt = $("manifestUrl").textContent;
    navigator.clipboard.writeText(txt);
    $("cfgMsg").textContent = "Copied manifest URL";
  }
  function copyPython(){
    navigator.clipboard.writeText($("pyCode").textContent);
  }

  async function refreshAll(){
    await checkHealth();
    await loadConfig();
    await refreshLatest();
    await refreshVersions();
    await refreshLogs();
  }

  window.addEventListener("hashchange", () => setPage(location.hash));
  setPage(location.hash);

  $("cfgAppId").value = localStorage.getItem("app_id") || "1999x";
  $("cfgVersion").value = "1.0.0";

  refreshAll();
  setInterval(checkHealth, 3000);
  setInterval(refreshLogs, 2000);
</script>
</body>
</html>